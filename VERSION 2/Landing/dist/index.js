var __getOwnPropNames = Object.getOwnPropertyNames;
var __commonJS = (cb, mod) => function __require() {
  return mod || (0, cb[__getOwnPropNames(cb)[0]])((mod = { exports: {} }).exports, mod), mod.exports;
};

// server/data/navotas_pois.json
var require_navotas_pois = __commonJS({
  "server/data/navotas_pois.json"(exports, module) {
    module.exports = [
      {
        id: "navotas-01",
        name: "Navotas City Hall",
        lat: 14.4362,
        lon: 120.9309,
        keywords: ["city hall", "government", "muni", "navotas"]
      },
      {
        id: "navotas-02",
        name: "Navotas Fish Port Complex",
        lat: 14.4341,
        lon: 120.9297,
        keywords: ["fish port", "port", "market", "navotas"]
      },
      {
        id: "navotas-03",
        name: "Navotas City Public Market",
        lat: 14.4349,
        lon: 120.9324,
        keywords: ["market", "public market", "navotas"]
      },
      {
        id: "navotas-04",
        name: "Tanza Barangay Hall",
        lat: 14.4278,
        lon: 120.9342,
        keywords: ["tanza", "barangay hall", "navotas"]
      },
      {
        id: "navotas-05",
        name: "Bangculasi Barangay Center",
        lat: 14.438,
        lon: 120.9361,
        keywords: ["bangculasi", "barangay", "navotas"]
      },
      {
        id: "navotas-06",
        name: "Tangos North Barangay Hall",
        lat: 14.4445,
        lon: 120.929,
        keywords: ["tangos north", "barangay", "navotas"]
      },
      {
        id: "navotas-07",
        name: "Tangos South Barangay Hall",
        lat: 14.4345,
        lon: 120.9218,
        keywords: ["tangos south", "barangay", "navotas"]
      },
      {
        id: "navotas-08",
        name: "Daanghari Bridge",
        lat: 14.4319,
        lon: 120.9229,
        keywords: ["daanghari", "bridge", "navotas"]
      },
      {
        id: "navotas-09",
        name: "North Bay Boulevard North (NBBD)",
        lat: 14.4391,
        lon: 120.9315,
        keywords: ["north bay", "boulevard", "nbbd", "navotas"]
      },
      {
        id: "navotas-10",
        name: "North Bay Boulevard South",
        lat: 14.431,
        lon: 120.9332,
        keywords: ["north bay", "boulevard south", "navotas"]
      },
      {
        id: "navotas-11",
        name: "San Jose Barangay Hall",
        lat: 14.4408,
        lon: 120.9357,
        keywords: ["san jose", "barangay", "navotas"]
      },
      {
        id: "navotas-12",
        name: "Navotas City Hospital",
        lat: 14.4356,
        lon: 120.9274,
        keywords: ["hospital", "clinic", "navotas city hospital"]
      },
      {
        id: "navotas-13",
        name: "Navotas Polytechnic College",
        lat: 14.4327,
        lon: 120.9368,
        keywords: ["college", "navotas polytechnic", "education", "navotas"]
      },
      {
        id: "navotas-14",
        name: "Navotas Center Mall",
        lat: 14.4373,
        lon: 120.9286,
        keywords: ["mall", "shopping", "navotas center"]
      },
      {
        id: "navotas-15",
        name: "Navotas River Mouth",
        lat: 14.4264,
        lon: 120.9265,
        keywords: ["river", "mouth", "navotas river"]
      },
      {
        id: "navotas-16",
        name: "Navotas Bus Terminal",
        lat: 14.4338,
        lon: 120.9311,
        keywords: ["bus terminal", "transport", "navotas"]
      },
      {
        id: "navotas-17",
        name: "Navotas Police Station",
        lat: 14.4389,
        lon: 120.9319,
        keywords: ["police", "pnp", "station", "navotas"]
      },
      {
        id: "navotas-18",
        name: "Navotas Public Library",
        lat: 14.4331,
        lon: 120.9352,
        keywords: ["library", "public library", "navotas"]
      },
      {
        id: "navotas-19",
        name: "Navotas City Disaster Risk Reduction Office",
        lat: 14.435,
        lon: 120.9335,
        keywords: ["drrm", "disaster", "office", "navotas"]
      },
      {
        id: "navotas-20",
        name: "Navotas City Sports Complex",
        lat: 14.4412,
        lon: 120.9294,
        keywords: ["sports complex", "stadium", "navotas"]
      },
      {
        id: "navotas-21",
        name: "Navotas Youth Center",
        lat: 14.4394,
        lon: 120.9248,
        keywords: ["youth center", "community", "navotas"]
      },
      {
        id: "navotas-22",
        name: "Navotas Coastal Road",
        lat: 14.4279,
        lon: 120.9293,
        keywords: ["coastal", "road", "navotas"]
      },
      {
        id: "navotas-23",
        name: "Navotas Fish Port Market",
        lat: 14.4345,
        lon: 120.9282,
        keywords: ["fish market", "market", "navotas"]
      },
      {
        id: "navotas-24",
        name: "Navotas Municipal Cemetery",
        lat: 14.4461,
        lon: 120.9336,
        keywords: ["cemetery", "memorial", "navotas"]
      },
      {
        id: "navotas-25",
        name: "Navotas Elementary School",
        lat: 14.4367,
        lon: 120.9255,
        keywords: ["elementary", "school", "education", "navotas"]
      },
      {
        id: "navotas-26",
        name: "Navotas High School",
        lat: 14.4336,
        lon: 120.9371,
        keywords: ["high school", "school", "education", "navotas"]
      },
      {
        id: "navotas-27",
        name: "North Harbor - Navotas Access",
        lat: 14.4299,
        lon: 120.9422,
        keywords: ["north harbor", "harbor", "port", "navotas"]
      },
      {
        id: "navotas-28",
        name: "Navotas Health Center 1",
        lat: 14.4305,
        lon: 120.9338,
        keywords: ["health center", "clinic", "navotas"]
      },
      {
        id: "navotas-29",
        name: "Navotas Health Center 2",
        lat: 14.4382,
        lon: 120.9262,
        keywords: ["health center", "clinic", "navotas"]
      },
      {
        id: "navotas-30",
        name: "Navotas Covered Court (Tanza)",
        lat: 14.4283,
        lon: 120.9356,
        keywords: ["covered court", "sports", "tanza", "navotas"]
      },
      {
        id: "navotas-31",
        name: "Navotas Elementary Annex",
        lat: 14.4342,
        lon: 120.9339,
        keywords: ["school annex", "elementary", "navotas"]
      },
      {
        id: "navotas-32",
        name: "Navotas Slaughterhouse",
        lat: 14.432,
        lon: 120.9234,
        keywords: ["slaughterhouse", "market", "navotas"]
      },
      {
        id: "navotas-33",
        name: "Barangay Daanghari Health Post",
        lat: 14.4334,
        lon: 120.921,
        keywords: ["health post", "daanghari", "navotas"]
      },
      {
        id: "navotas-34",
        name: "Navotas Marina Terminal",
        lat: 14.4256,
        lon: 120.9279,
        keywords: ["marina", "terminal", "ferry", "navotas"]
      },
      {
        id: "navotas-35",
        name: "Navotas Police Station 2",
        lat: 14.4418,
        lon: 120.935,
        keywords: ["police", "pnp", "station", "navotas"]
      },
      {
        id: "navotas-36",
        name: "Navotas Senior Citizens Center",
        lat: 14.4371,
        lon: 120.9369,
        keywords: ["senior", "community", "center", "navotas"]
      },
      {
        id: "navotas-37",
        name: "Navotas Waterworks Facility",
        lat: 14.4314,
        lon: 120.9267,
        keywords: ["waterworks", "facility", "navotas"]
      },
      {
        id: "navotas-38",
        name: "Navotas Fire Station",
        lat: 14.4359,
        lon: 120.9313,
        keywords: ["fire station", "bfp", "navotas"]
      },
      {
        id: "navotas-39",
        name: "Navotas Post Office",
        lat: 14.4369,
        lon: 120.9328,
        keywords: ["post office", "mail", "navotas"]
      },
      {
        id: "navotas-40",
        name: "Navotas Barangay Emergency Evacuation Center",
        lat: 14.4399,
        lon: 120.9384,
        keywords: ["evacuation", "center", "evac", "navotas"]
      },
      {
        id: "navotas-41",
        name: "Navotas Night Market",
        lat: 14.4352,
        lon: 120.9291,
        keywords: ["night market", "market", "navotas"]
      },
      {
        id: "navotas-42",
        name: "Navotas Coastal Evacuation Route",
        lat: 14.4268,
        lon: 120.9322,
        keywords: ["evacuation", "route", "coastal", "navotas"]
      },
      {
        id: "navotas-43",
        name: "Navotas Community Health Center",
        lat: 14.433,
        lon: 120.926,
        keywords: ["community health", "clinic", "navotas"]
      },
      {
        id: "navotas-44",
        name: "Navotas Drainage Pump Station",
        lat: 14.4309,
        lon: 120.9401,
        keywords: ["pump station", "drainage", "navotas"]
      },
      {
        id: "navotas-45",
        name: "Navotas Logistics Hub",
        lat: 14.4272,
        lon: 120.9366,
        keywords: ["logistics", "hub", "warehouse", "navotas"]
      },
      {
        id: "navotas-46",
        name: "Navotas Barangay Hall - Northbay",
        lat: 14.4386,
        lon: 120.9229,
        keywords: ["northbay", "barangay hall", "navotas"]
      },
      {
        id: "navotas-47",
        name: "Navotas Water Distribution Center",
        lat: 14.4323,
        lon: 120.9387,
        keywords: ["water distribution", "center", "navotas"]
      },
      {
        id: "navotas-48",
        name: "Navotas Coastal Protection Park",
        lat: 14.4248,
        lon: 120.9304,
        keywords: ["park", "coastal", "green", "navotas"]
      },
      {
        id: "navotas-49",
        name: "Navotas Ferry Landing",
        lat: 14.4252,
        lon: 120.9358,
        keywords: ["ferry", "landing", "terminal", "navotas"]
      },
      {
        id: "navotas-50",
        name: "Navotas Community Evacuation Center - Tanza",
        lat: 14.429,
        lon: 120.9392,
        keywords: ["evacuation", "tanza", "center", "navotas"]
      }
    ];
  }
});

// server/index.ts
import { webcrypto } from "crypto";
import express2 from "express";

// server/routes.ts
import { createServer } from "http";

// server/storage.ts
import { randomUUID } from "crypto";
var MemStorage = class {
  users;
  barangayClaims;
  userProfiles;
  constructor() {
    this.users = /* @__PURE__ */ new Map();
    this.barangayClaims = /* @__PURE__ */ new Map();
    this.userProfiles = /* @__PURE__ */ new Map();
  }
  async getUser(id) {
    return this.users.get(id);
  }
  async getUserByUsername(username) {
    return Array.from(this.users.values()).find(
      (user) => user.username === username
    );
  }
  async createUser(insertUser) {
    const id = randomUUID();
    const user = { ...insertUser, id };
    this.users.set(id, user);
    return user;
  }
  async claimBarangay(barangayCode, userId, username) {
    const existing = this.barangayClaims.get(barangayCode);
    if (existing) {
      return null;
    }
    const claim = {
      barangayCode,
      userId,
      username,
      claimedAt: Date.now()
    };
    this.barangayClaims.set(barangayCode, claim);
    return claim;
  }
  async getBarangayClaim(barangayCode) {
    return this.barangayClaims.get(barangayCode);
  }
  async getAllClaims() {
    return Array.from(this.barangayClaims.values());
  }
  async saveUserProfile(profile) {
    this.userProfiles.set(profile.username.toLowerCase(), profile);
  }
  async getUserProfile(username) {
    return this.userProfiles.get(username.toLowerCase());
  }
  async resetAll() {
    this.users.clear();
    this.barangayClaims.clear();
    this.userProfiles.clear();
    console.log("\u{1F5D1}\uFE0F All storage data has been reset");
  }
};
var storage = new MemStorage();

// server/routes.ts
import session from "express-session";
import bcrypt from "bcryptjs";

// shared/schema.ts
import { sql } from "drizzle-orm";
import { pgTable, text, varchar } from "drizzle-orm/pg-core";
import { createInsertSchema } from "drizzle-zod";
var users = pgTable("users", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  username: text("username").notNull().unique(),
  password: text("password").notNull()
});
var insertUserSchema = createInsertSchema(users).pick({
  username: true,
  password: true
});

// server/routes.ts
import fs from "fs";
import path from "path";
async function registerRoutes(app2) {
  const SESSION_SECRET = process.env.SESSION_SECRET || "dev-secret-change-me";
  app2.use(
    session({
      secret: SESSION_SECRET,
      resave: false,
      saveUninitialized: false,
      cookie: {
        secure: process.env.NODE_ENV === "production",
        httpOnly: true,
        sameSite: "strict",
        maxAge: 1e3 * 60 * 60 * 24 * 7
      }
    })
  );
  app2.post("/api/auth/signup", async (req, res) => {
    try {
      const result = insertUserSchema.safeParse(req.body);
      if (!result.success) {
        return res.status(400).json({ message: "Invalid input" });
      }
      const { username, password } = result.data;
      const existingUser = await storage.getUserByUsername(username);
      if (existingUser) {
        return res.status(400).json({ message: "Username already exists" });
      }
      const hashedPassword = await bcrypt.hash(password, 10);
      const user = await storage.createUser({ username, password: hashedPassword });
      req.session.userId = user.id;
      res.status(201).json({ message: "User created successfully", user: { id: user.id, username: user.username } });
    } catch (error) {
      console.error("Signup error:", error);
      res.status(500).json({ message: "Internal server error" });
    }
  });
  app2.post("/api/auth/login", async (req, res) => {
    try {
      const { username, password } = req.body;
      if (!username || !password) {
        return res.status(400).json({ message: "Username and password are required" });
      }
      const user = await storage.getUserByUsername(username);
      if (!user) {
        return res.status(401).json({ message: "Invalid credentials" });
      }
      const isValid = await bcrypt.compare(password, user.password);
      if (!isValid) {
        return res.status(401).json({ message: "Invalid credentials" });
      }
      req.session.userId = user.id;
      res.json({ message: "Login successful", user: { id: user.id, username: user.username } });
    } catch (error) {
      console.error("Login error:", error);
      res.status(500).json({ message: "Internal server error" });
    }
  });
  app2.post("/api/auth/logout", (req, res) => {
    req.session.destroy((err) => {
      if (err) {
        return res.status(500).json({ message: "Logout failed" });
      }
      res.json({ message: "Logout successful" });
    });
  });
  app2.get("/api/auth/me", async (req, res) => {
    const userId = req.session.userId;
    if (!userId) {
      return res.status(401).json({ message: "Not authenticated" });
    }
    const user = await storage.getUser(userId);
    if (!user) {
      return res.status(401).json({ message: "User not found" });
    }
    res.json({ user: { id: user.id, username: user.username } });
  });
  app2.get("/api/geocode", async (req, res) => {
    try {
      const q = req.query.q;
      if (!q) {
        return res.status(400).json({ message: "Search query is required" });
      }
      try {
        const pois = require_navotas_pois();
        const qLower = q.toLowerCase().trim();
        let match = pois.find((p) => p.name.toLowerCase().includes(qLower));
        if (!match) {
          match = pois.find((p) => (p.keywords || []).some((k) => k.toLowerCase().includes(qLower) || qLower.includes(k.toLowerCase())));
        }
        if (match) {
          return res.json({ lat: match.lat, lon: match.lon, displayName: match.name, source: "local" });
        }
      } catch (err) {
        console.warn("Local POIs load failed:", err);
      }
      const searchQuery = `${q}, Philippines`;
      const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchQuery)}&format=json&limit=1`;
      const response = await fetch(url, {
        headers: { "User-Agent": "iReady-App/1.0" }
      });
      if (!response.ok) {
        return res.status(response.status).json({ message: "Geocoding service error" });
      }
      const data = await response.json();
      if (!Array.isArray(data) || data.length === 0) {
        return res.status(404).json({ message: "Location not found" });
      }
      const { lat, lon, display_name } = data[0];
      res.json({ lat: parseFloat(lat), lon: parseFloat(lon), displayName: display_name, source: "nominatim" });
    } catch (error) {
      console.error("Geocoding error:", error);
      res.status(500).json({ message: "Internal server error" });
    }
  });
  app2.get("/api/toreceive", async (_req, res) => {
    try {
      const filePath = path.resolve(__dirname, "..", "..", "Data", "ToReceive.json");
      if (!fs.existsSync(filePath)) {
        return res.status(500).json({ message: "ToReceive data not found" });
      }
      const raw = fs.readFileSync(filePath, "utf-8");
      const parsed = JSON.parse(raw);
      const codes = parsed.map((r) => r.adm4_pcode).filter(Boolean);
      res.json({ codes });
    } catch (err) {
      console.error("/api/toreceive error:", err);
      res.status(500).json({ message: "Failed to read ToReceive data" });
    }
  });
  app2.get("/api/pois", async (req, res) => {
    try {
      const q = req.query.q;
      const all = req.query.all === "true";
      const poisPath = path.resolve(__dirname, "data", "navotas_pois.json");
      if (!fs.existsSync(poisPath)) {
        return res.json({ results: [] });
      }
      const pois = JSON.parse(fs.readFileSync(poisPath, "utf-8"));
      if (all) {
        return res.json({ results: pois });
      }
      if (!q) {
        return res.json({ results: pois.slice(0, 10) });
      }
      const qLower = q.toLowerCase();
      const filtered = pois.filter(
        (p) => p.name?.toLowerCase().includes(qLower) || (p.keywords || []).some((k) => k.toLowerCase().includes(qLower))
      ).slice(0, 10);
      res.json({ results: filtered });
    } catch (err) {
      console.error("/api/pois error:", err);
      res.json({ results: [] });
    }
  });
  app2.get("/api/adm4", async (req, res) => {
    try {
      const q = req.query.q;
      const filePath = path.resolve(__dirname, "..", "..", "Data", "ToReceive.json");
      if (!fs.existsSync(filePath)) {
        return res.json({ results: [] });
      }
      const raw = fs.readFileSync(filePath, "utf-8");
      const parsed = JSON.parse(raw);
      if (!q) {
        return res.json({ results: parsed.slice(0, 10) });
      }
      const qLower = q.toLowerCase();
      const filtered = parsed.filter(
        (item) => item.adm4_pcode?.toLowerCase().includes(qLower)
      ).slice(0, 10);
      res.json({ results: filtered });
    } catch (err) {
      console.error("/api/adm4 error:", err);
      res.json({ results: [] });
    }
  });
  app2.get("/api/reverse", async (req, res) => {
    try {
      const lat = req.query.lat;
      const lon = req.query.lon;
      if (!lat || !lon) return res.status(400).json({ message: "lat and lon required" });
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=10&addressdetails=0`;
      const response = await fetch(url, { headers: { "User-Agent": "iReady-App/1.0" } });
      if (!response.ok) return res.status(502).json({ message: "Reverse geocode failed" });
      const data = await response.json();
      const display = (data.display_name || "").toLowerCase();
      const waterKeywords = ["sea", "bay", "ocean", "lake", "river", "channel", "canal", "marina", "harbor", "harbour"];
      const isWater = waterKeywords.some((k) => display.includes(k));
      res.json({ displayName: data.display_name || null, isWater });
    } catch (err) {
      console.error("/api/reverse error:", err);
      res.status(500).json({ message: "Reverse lookup failed" });
    }
  });
  app2.post("/api/barangay/claim", async (req, res) => {
    try {
      const userId = req.session.userId;
      if (!userId) {
        return res.status(401).json({ message: "Not authenticated" });
      }
      const user = await storage.getUser(userId);
      if (!user) {
        return res.status(401).json({ message: "User not found" });
      }
      const { barangayCode } = req.body;
      if (!barangayCode) {
        return res.status(400).json({ message: "Barangay code is required" });
      }
      const claim = await storage.claimBarangay(barangayCode, userId, user.username);
      if (!claim) {
        return res.status(409).json({ message: "Barangay already claimed by another user" });
      }
      res.json({ success: true, claim });
    } catch (error) {
      console.error("Claim barangay error:", error);
      res.status(500).json({ message: "Internal server error" });
    }
  });
  app2.get("/api/barangay/claim/:code", async (req, res) => {
    try {
      const { code } = req.params;
      const claim = await storage.getBarangayClaim(code);
      if (!claim) {
        return res.json({ claimed: false });
      }
      res.json({
        claimed: true,
        claimant: claim.username,
        claimedAt: claim.claimedAt
      });
    } catch (error) {
      console.error("Get barangay claim error:", error);
      res.status(500).json({ message: "Internal server error" });
    }
  });
  app2.get("/api/barangay/claims", async (req, res) => {
    try {
      const claims = await storage.getAllClaims();
      res.json({ claims });
    } catch (error) {
      console.error("Get all claims error:", error);
      res.status(500).json({ message: "Internal server error" });
    }
  });
  app2.post("/api/profile", async (req, res) => {
    try {
      const userId = req.session.userId;
      if (!userId) {
        return res.status(401).json({ message: "Not authenticated" });
      }
      const user = await storage.getUser(userId);
      if (!user) {
        return res.status(401).json({ message: "User not found" });
      }
      const { summary, email, phone, socialLinks } = req.body;
      console.log(`Saving profile for user ${user.username}:`, { summary, email, phone, socialLinks });
      await storage.saveUserProfile({
        userId: user.id,
        username: user.username,
        summary,
        email,
        phone,
        socialLinks
      });
      res.json({ success: true, message: "Profile saved" });
    } catch (error) {
      console.error("Save profile error:", error);
      res.status(500).json({ message: "Internal server error" });
    }
  });
  app2.get("/api/profile/:username", async (req, res) => {
    try {
      const { username } = req.params;
      console.log(`Fetching profile for username: ${username}`);
      const profile = await storage.getUserProfile(username);
      console.log(`Profile found:`, profile);
      if (!profile) {
        return res.json({
          username,
          summary: null,
          email: null,
          phone: null,
          socialLinks: []
        });
      }
      res.json(profile);
    } catch (error) {
      console.error("Get profile error:", error);
      res.status(500).json({ message: "Internal server error" });
    }
  });
  app2.post("/api/reset-all", async (req, res) => {
    try {
      await storage.resetAll();
      req.session.destroy((err) => {
        if (err) {
          console.error("Session destroy error:", err);
        }
      });
      res.json({ message: "All data has been reset successfully" });
    } catch (error) {
      console.error("Reset all error:", error);
      res.status(500).json({ message: "Internal server error" });
    }
  });
  const httpServer = createServer(app2);
  return httpServer;
}

// server/vite.ts
import express from "express";
import fs2 from "fs";
import path3 from "path";
import { createServer as createViteServer, createLogger } from "vite";

// vite.config.ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import path2 from "path";
import runtimeErrorOverlay from "@replit/vite-plugin-runtime-error-modal";
import { fileURLToPath } from "url";
var __filename = fileURLToPath(import.meta.url);
var __dirname2 = path2.dirname(__filename);
var vite_config_default = defineConfig({
  plugins: [
    react(),
    runtimeErrorOverlay(),
    ...process.env.NODE_ENV !== "production" && process.env.REPL_ID !== void 0 ? [
      await import("@replit/vite-plugin-cartographer").then((m) => m.cartographer()),
      await import("@replit/vite-plugin-dev-banner").then((m) => m.devBanner())
    ] : []
  ],
  resolve: {
    alias: {
      "@": path2.resolve(__dirname2, "client", "src"),
      "@shared": path2.resolve(__dirname2, "shared"),
      "@assets": path2.resolve(__dirname2, "attached_assets")
    }
  },
  root: path2.resolve(__dirname2, "client"),
  build: {
    outDir: path2.resolve(__dirname2, "dist/public"),
    emptyOutDir: true
  },
  server: {
    fs: {
      strict: true,
      deny: ["**/.*"]
    }
  }
});

// server/vite.ts
import { nanoid } from "nanoid";
var viteLogger = createLogger();
function log(message, source = "express") {
  const formattedTime = (/* @__PURE__ */ new Date()).toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true
  });
  console.log(`${formattedTime} [${source}] ${message}`);
}
async function setupVite(app2, server) {
  const serverOptions = {
    middlewareMode: true,
    hmr: { server },
    allowedHosts: true
  };
  const vite = await createViteServer({
    ...vite_config_default,
    configFile: false,
    customLogger: {
      ...viteLogger,
      error: (msg, options) => {
        viteLogger.error(msg, options);
        process.exit(1);
      }
    },
    server: serverOptions,
    appType: "custom"
  });
  app2.use(vite.middlewares);
  app2.use("*", async (req, res, next) => {
    const url = req.originalUrl;
    try {
      const clientTemplate = path3.resolve(
        import.meta.dirname,
        "..",
        "client",
        "index.html"
      );
      let template = await fs2.promises.readFile(clientTemplate, "utf-8");
      template = template.replace(
        `src="/src/main.tsx"`,
        `src="/src/main.tsx?v=${nanoid()}"`
      );
      const page = await vite.transformIndexHtml(url, template);
      res.status(200).set({ "Content-Type": "text/html" }).end(page);
    } catch (e) {
      vite.ssrFixStacktrace(e);
      next(e);
    }
  });
}
function serveStatic(app2) {
  const distPath = path3.resolve(import.meta.dirname, "public");
  if (!fs2.existsSync(distPath)) {
    throw new Error(
      `Could not find the build directory: ${distPath}, make sure to build the client first`
    );
  }
  app2.use(express.static(distPath));
  app2.use("*", (_req, res) => {
    res.sendFile(path3.resolve(distPath, "index.html"));
  });
}

// server/index.ts
if (!globalThis.crypto) {
  Object.defineProperty(globalThis, "crypto", {
    value: webcrypto,
    configurable: false,
    enumerable: true,
    writable: false
  });
}
var app = express2();
app.use(express2.json());
app.use(express2.urlencoded({ extended: false }));
app.use((req, res, next) => {
  const start = Date.now();
  const path4 = req.path;
  let capturedJsonResponse = void 0;
  const originalResJson = res.json;
  res.json = function(bodyJson, ...args) {
    capturedJsonResponse = bodyJson;
    return originalResJson.apply(res, [bodyJson, ...args]);
  };
  res.on("finish", () => {
    const duration = Date.now() - start;
    if (path4.startsWith("/api")) {
      let logLine = `${req.method} ${path4} ${res.statusCode} in ${duration}ms`;
      if (capturedJsonResponse) {
        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;
      }
      if (logLine.length > 80) {
        logLine = logLine.slice(0, 79) + "\u2026";
      }
      log(logLine);
    }
  });
  next();
});
(async () => {
  const server = await registerRoutes(app);
  app.use((err, _req, res, _next) => {
    const status = err.status || err.statusCode || 500;
    const message = err.message || "Internal Server Error";
    res.status(status).json({ message });
    throw err;
  });
  if (app.get("env") === "development") {
    await setupVite(app, server);
  } else {
    serveStatic(app);
  }
  const port = parseInt(process.env.PORT || "5050", 10);
  server.listen({
    port,
    host: "0.0.0.0"
  }, () => {
    log(`serving on port ${port}`);
  });
})();
